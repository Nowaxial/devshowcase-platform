@page "/admin/dashboard"
@using DevShowcase.Client.Shared
@using Microsoft.AspNetCore.Authorization
@using DevShowCase.Client.Shared
@using DevShowcase.Client.Services
@using DevShowcase.Shared.DTOs.Admin
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@inject ApiService ApiService
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Admin Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <div class="d-flex justify-space-between align-center mb-8">
        <div>
            <MudText Typo="Typo.h3" Class="font-weight-bold">Dashboard</MudText>
            <MudText Typo="Typo.subtitle1" Class="mud-text-secondary">Welcome back! Here's an overview of your portfolio.</MudText>
        </div>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@LucideIcons.Sun" IconClass="lucide-icon" Href="@GetPublicProfileUrl()" Target="_blank">
            View Live Site
        </MudButton>
    </div>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-6" />
    }
    else
    {
        <!-- Key Stats -->
        <MudGrid Class="mb-8">
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="2" Class="pa-4 d-flex align-center h-100 border-l-4 border-solid mud-border-primary">
                    <MudIcon Icon="@LucideIcons.Briefcase" IconClass="lucide-icon mr-4" Size="Size.Large" Color="Color.Primary" />
                    <div>
                        <MudText Typo="Typo.h4">@_stats.TotalExperience</MudText>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">Work Experiences</MudText>
                    </div>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="2" Class="pa-4 d-flex align-center h-100 border-l-4 border-solid mud-border-secondary">
                    <MudIcon Icon="@LucideIcons.Code" IconClass="lucide-icon mr-4" Size="Size.Large" Color="Color.Secondary" />
                    <div>
                        <MudText Typo="Typo.h4">@_stats.TotalProjects</MudText>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">Projects Built</MudText>
                    </div>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="2" Class="pa-4 d-flex align-center h-100 border-l-4 border-solid mud-border-info">
                    <MudIcon Icon="@LucideIcons.Wrench" IconClass="lucide-icon mr-4" Size="Size.Large" Color="Color.Info" />
                    <div>
                        <MudText Typo="Typo.h4">@_stats.TotalSkills</MudText>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">Technical Skills</MudText>
                    </div>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="@(_stats.UnreadMessagesCount > 0 ? 4 : 2)" Class="@($"pa-4 d-flex align-center h-100 border-l-4 border-solid {(_stats.UnreadMessagesCount > 0 ? "mud-border-warning" : "mud-border-success")}")">
                    <MudIcon Icon="@LucideIcons.MessageSquare" IconClass="lucide-icon mr-4" Size="Size.Large" Color="@(_stats.UnreadMessagesCount > 0 ? Color.Warning : Color.Success)" />
                    <div>
                        <MudText Typo="Typo.h4">@_stats.UnreadMessagesCount</MudText>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">Unread Messages</MudText>
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudText Typo="Typo.h5" Class="mb-4 font-weight-bold">Quick Actions</MudText>
        <MudGrid>
            @foreach (var action in _quickActions)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="2" Class="h-100 hover-card mud-border-solid border-1">
                        <MudCardHeader>
                            <CardHeaderAvatar>
                                <MudIcon Icon="@action.Icon" IconClass="lucide-icon" Size="Size.Medium" Color="@action.Color" />
                            </CardHeaderAvatar>
                            <CardHeaderContent>
                                <MudText Typo="Typo.subtitle1" Class="font-weight-bold">@action.Title</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">@action.Description</MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Href="@action.Link" Variant="Variant.Text" Color="@action.Color" EndIcon="@Icons.Material.Filled.ArrowForward">Manage</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

<style>
    .hover-card:hover {
        border-color: var(--mud-palette-primary) !important;
        cursor: pointer;
    }

    .border-l-4 {
        border-left-width: 4px !important;
    }
</style>

@code {
    private DashboardStatsDto _stats = new();
    private bool _loading = true;
    private string _currentUsername = "default";
    private List<QuickAction> _quickActions = new();

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        try
        {
            // Hämta användarens username från JWT token
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                _currentUsername = authState.User.Identity.Name ?? "default";
            }

            _stats = await ApiService.GetDashboardStatsAsync();
            InitializeActions();
        }
        catch (Exception)
        {
            // Error handling could be added here
        }
        _loading = false;
    }

    private string GetPublicProfileUrl()
    {
        return $"/{_currentUsername}";
    }

    private void InitializeActions()
    {
        _quickActions = new List<QuickAction>
        {
            new("Experiences", "Manage your work history.", "/admin/experience", LucideIcons.Briefcase, Color.Primary),
            new("Projects", "Showcase your portfolio work.", "/admin/projects", LucideIcons.Code, Color.Secondary),
            new("Education", "Academic background.", "/admin/education", LucideIcons.GraduationCap, Color.Info),
            new("Skills", "Technical and soft skills.", "/admin/skills", LucideIcons.Wrench, Color.Success),
            new("Certificates", "Licenses and awards.", "/admin/licenses", LucideIcons.Award, Color.Warning),
            new("Languages", "Multilingual capabilities.", "/admin/languages", LucideIcons.Languages, Color.Tertiary),
            new("Tech Stack", "Tools and frameworks.", "/admin/techstack", LucideIcons.Layers, Color.Primary),
            new("Competencies", "Core focus areas.", "/admin/competencies", LucideIcons.Sparkles, Color.Secondary),
            new("Settings", "AI and App preferences.", "/admin/settings", LucideIcons.Settings, Color.Default)
        };
    }

    private record QuickAction(string Title, string Description, string Link, string Icon, Color Color);
}
