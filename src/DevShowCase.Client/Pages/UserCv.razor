@page "/{username}/cv"
@layout PortfolioLayout
@using DevShowcase.Client.Shared
@using DevShowcase.Shared.DTOs.Public
@using DevShowcase.Client.Services
@implements IDisposable

<PageTitle>@(Portfolio?.FirstName ?? username) - CV</PageTitle>

@if (Portfolio == null)
{
    @if (!PortfolioState.IsLoading)
    {
        <MudContainer MaxWidth="MaxWidth.Small" Class="mt-16 text-center">
            <MudText Typo="Typo.h4">Portfolio Not Found</MudText>
            <MudText Typo="Typo.body1" Class="mt-2">The requested user portfolio could not be found.</MudText>
        </MudContainer>
    }
}
else
{
    <main class="cv-page">
        <section class="cv-container" aria-label="Resume Content">
            
            @* Header Section *@
            <header class="cv-header">
                <div class="cv-header-content">
                    <h1 class="cv-name">@Portfolio.FirstName @Portfolio.LastName</h1>
                    <p class="cv-headline">@Portfolio.Bio</p>
                    
                    <p class="cv-location">
                        <a href="@($"https://www.google.com/maps/search/{Uri.EscapeDataString(Portfolio.Location ?? "")}")" target="_blank" rel="noopener noreferrer">
                            @Portfolio.Location
                        </a>
                    </p>

                    <div class="cv-social-links" role="list">
                        @if (!string.IsNullOrEmpty(Portfolio.Email))
                        {
                            <a href="mailto:@Portfolio.Email" aria-label="Email" class="cv-icon-btn">
                                <MudIcon Icon="@LucideIcons.Mail" Size="Size.Small" />
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(Portfolio.GithubUrl))
                        {
                            <a href="@Portfolio.GithubUrl" target="_blank" aria-label="GitHub" class="cv-icon-btn">
                                <MudIcon Icon="@LucideIcons.Github" Size="Size.Small" />
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(Portfolio.LinkedInUrl))
                        {
                            <a href="@Portfolio.LinkedInUrl" target="_blank" aria-label="LinkedIn" class="cv-icon-btn">
                                <MudIcon Icon="@LucideIcons.Linkedin" Size="Size.Small" />
                            </a>
                        }
                    </div>
                </div>

                <div class="cv-avatar-container">
                    @if (!string.IsNullOrEmpty(Portfolio.ProfileImageUrl))
                    {
                        <img class="cv-avatar" src="@Portfolio.ProfileImageUrl" alt="@Portfolio.FirstName @Portfolio.LastName" />
                    }
                    else
                    {
                        <div class="cv-avatar-placeholder">
                            @Portfolio.FirstName?.FirstOrDefault()@Portfolio.LastName?.FirstOrDefault()
                        </div>
                    }
                </div>
            </header>

            <div class="cv-body">
                @* About Section *@
                <section class="cv-section">
                    <h2 class="cv-section-title">About</h2>
                    <div class="cv-section-text">
                        @Portfolio.Bio
                    </div>
                </section>

                @* Work Experience Section *@
                @if (Portfolio.Experiences.Any())
                {
                    <section class="cv-section">
                        <h2 class="cv-section-title">Work Experience</h2>
                        <div class="cv-list">
                            @foreach (var exp in Portfolio.Experiences.OrderByDescending(e => e.StartDate))
                            {
                                <div class="cv-item">
                                    <div class="cv-item-header">
                                        <div class="cv-item-title-row">
                                            <h3 class="cv-item-title">@exp.Position</h3>
                                            @if (!string.IsNullOrEmpty(exp.Location))
                                            {
                                                <span class="cv-badge">@exp.Location</span>
                                            }
                                        </div>
                                        <span class="cv-item-date">
                                            @exp.StartDate.ToString("MMM yyyy") - @(exp.IsCurrent ? "Present" : exp.EndDate?.ToString("MMM yyyy"))
                                        </span>
                                    </div>
                                    <div class="cv-item-sub">
                                        <span class="cv-company">@exp.Company</span>
                                        @if (!string.IsNullOrEmpty(exp.EmploymentType))
                                        {
                                            <span>â€¢ @exp.EmploymentType</span>
                                        }
                                    </div>
                                    <p class="cv-item-description">@exp.Description</p>
                                </div>
                            }
                        </div>
                    </section>
                }

                @* Education Section *@
                @if (Portfolio.Education.Any())
                {
                    <section class="cv-section">
                        <h2 class="cv-section-title">Education</h2>
                        <div class="cv-list">
                            @foreach (var edu in Portfolio.Education.OrderByDescending(e => e.StartDate))
                            {
                                <div class="cv-item">
                                    <div class="cv-item-header">
                                        <h3 class="cv-item-title">@edu.Institution</h3>
                                        <span class="cv-item-date">
                                            @edu.StartDate.ToString("yyyy") - @(edu.EndDate?.ToString("yyyy") ?? "Present")
                                        </span>
                                    </div>
                                    <p class="cv-item-text">@edu.Degree, @edu.Field</p>
                                </div>
                            }
                        </div>
                    </section>
                }

                @* Skills Section *@
                @if (Portfolio.Skills.Any())
                {
                    <section class="cv-section">
                        <h2 class="cv-section-title">Skills</h2>
                        <div class="cv-tags">
                            @foreach (var skill in Portfolio.Skills)
                            {
                                <span class="cv-tag">@skill.Name</span>
                            }
                        </div>
                    </section>
                }
                
                @* Licenses Section *@
                @if (Portfolio.Licenses.Any())
                {
                    <section class="cv-section">
                        <h2 class="cv-section-title">Certifications</h2>
                        <div class="cv-list">
                            @foreach (var lic in Portfolio.Licenses.OrderByDescending(l => l.IssueDate))
                            {
                                <div class="cv-item">
                                    <div class="cv-item-header">
                                        <h3 class="cv-item-title">@lic.Name</h3>
                                        <span class="cv-item-date">@lic.IssueDate.ToString("MMM yyyy")</span>
                                    </div>
                                    <p class="cv-item-text">@lic.IssuingOrganization</p>
                                </div>
                            }
                        </div>
                    </section>
                }

                @* Languages Section *@
                @if (Portfolio.Languages.Any())
                {
                    <section class="cv-section">
                        <h2 class="cv-section-title">Languages</h2>
                        <div class="cv-tags">
                            @foreach (var lang in Portfolio.Languages)
                            {
                                <span class="cv-tag">@lang.Name (@lang.ProficiencyLevel)</span>
                            }
                        </div>
                    </section>
                }
            </div>
        </section>
    </main>
}

<style>
    :root {
        --cv-bg: #ffffff;
        --cv-text-main: #050914;
        --cv-text-muted: #6b737f;
        --cv-text-design: #4b5563;
        --cv-border: #e5e7eb;
        --cv-badge-bg: #eeeff0;
        --cv-badge-text: #54575e;
    }

    .cv-page {
        background-color: transparent;
        padding: 2rem 1rem;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .cv-container {
        max-width: 42rem; /* max-w-2xl */
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    @@media print {
        .cv-page { padding: 0; }
        .cv-container { max-width: 100%; gap: 1rem; }
    }

    /* Header */
    .cv-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
    }

    .cv-header-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
    }

    .cv-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--cv-text-main);
    }

    .cv-headline {
        font-size: 0.875rem;
        color: var(--cv-text-design);
        line-height: 1.5;
        max-width: 28rem;
    }

    .cv-location {
        font-size: 0.75rem;
    }

    .cv-location a {
        color: #9ca0a8;
        text-decoration: none;
    }

    .cv-location a:hover {
        text-decoration: underline;
    }

    .cv-social-links {
        display: flex;
        gap: 0.25rem;
        padding-top: 0.25rem;
    }

    .cv-icon-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        border: 1px solid var(--cv-border);
        border-radius: 0.375rem;
        background-color: var(--cv-bg);
        color: var(--cv-text-main);
        transition: all 0.2s;
    }

    .cv-icon-btn:hover {
        background-color: #f9fafb;
    }

    .cv-avatar-container {
        flex-shrink: 0;
    }

    .cv-avatar, .cv-avatar-placeholder {
        width: 5rem;
        height: 5rem;
        border-radius: 10px;
        object-fit: cover;
    }

    @@media (min-width: 768px) {
        .cv-avatar, .cv-avatar-placeholder {
            width: 7rem;
            height: 7rem;
        }
    }

    .cv-avatar-placeholder {
        background-color: var(--cv-badge-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1.5rem;
        color: var(--cv-badge-text);
    }

    /* Body */
    .cv-body {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .cv-section {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .cv-section-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--cv-text-main);
    }

    .cv-section-text {
        font-size: 0.875rem;
        color: var(--cv-text-design);
        line-height: 1.5;
        text-wrap: pretty;
    }

    /* Items */
    .cv-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .cv-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .cv-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .cv-item-title-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .cv-item-title {
        font-size: 1rem;
        font-weight: 600;
    }

    .cv-item-date {
        font-size: 0.875rem;
        color: var(--cv-text-muted);
        text-wrap: nowrap;
    }

    .cv-item-sub {
        font-size: 0.875rem;
        color: var(--cv-text-muted);
        display: flex;
        gap: 0.25rem;
    }

    .cv-item-description {
        font-size: 0.875rem;
        color: #6c737f;
        margin-top: 0.375rem;
    }

    .cv-item-text {
        font-size: 0.875rem;
        color: var(--cv-text-design);
    }

    .cv-badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.125rem 0.4375rem;
        background-color: var(--cv-badge-bg);
        color: var(--cv-badge-text);
        border-radius: 0.25rem;
    }

    /* Tags */
    .cv-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
    }

    .cv-tag {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.125rem 0.5rem;
        background-color: var(--cv-text-main);
        color: #ffffff;
        border-radius: 0.375rem;
    }
</style>

@code {
    [Parameter] public string username { get; set; } = string.Empty;
    [Inject] PortfolioStateService PortfolioState { get; set; } = null!;

    private PortfolioDto? Portfolio => PortfolioState.CurrentPortfolio;

    protected override void OnInitialized()
    {
        PortfolioState.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        PortfolioState.OnChange -= StateHasChanged;
    }
}
