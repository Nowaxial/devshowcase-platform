@page "/{username}/cv"
@layout PortfolioLayout
@using DevShowcase.Client.Shared
@using DevShowcase.Shared.DTOs.Public
@using DevShowcase.Client.Services
@implements IDisposable

<PageTitle>@(Portfolio?.FirstName ?? username) - CV</PageTitle>

@if (Portfolio == null)
{
    @if (!PortfolioState.IsLoading)
    {
        <MudContainer MaxWidth="MaxWidth.Small" Class="mt-16 text-center">
            <MudText Typo="Typo.h4">Portfolio Not Found</MudText>
            <MudText Typo="Typo.body1" Class="mt-2">The requested user portfolio could not be found.</MudText>
        </MudContainer>
    }
}
else
{
    <div class="cv-wrapper">
        <div class="cv-outer-container">
            <section class="cv-inner-content" aria-label="Resume Content">
                
                @* Header Section *@
                <header class="cv-header">
                    <div class="cv-header-text">
                        <h1 class="cv-name">@Portfolio.FirstName @Portfolio.LastName</h1>
                        <p class="cv-headline">@Portfolio.Bio</p>
                        
                        <p class="cv-location">
                            <a href="@($"https://www.google.com/maps/search/{Uri.EscapeDataString(Portfolio.Location ?? "")}")" target="_blank" rel="noopener noreferrer">
                                @Portfolio.Location
                            </a>
                        </p>

                        <div class="cv-social-links" role="list">
                            @if (!string.IsNullOrEmpty(Portfolio.Email))
                            {
                                <a href="mailto:@Portfolio.Email" aria-label="Email" target="_blank" class="cv-icon-btn">
                                    <MudIcon Icon="@LucideIcons.Mail" Style="stroke: currentColor; fill: none; stroke-width: 2;" />
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(Portfolio.GithubUrl))
                            {
                                <a href="@Portfolio.GithubUrl" target="_blank" aria-label="GitHub" class="cv-icon-btn">
                                    <MudIcon Icon="@LucideIcons.Github" Style="stroke: currentColor; fill: none; stroke-width: 2;" />
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(Portfolio.LinkedInUrl))
                            {
                                <a href="@Portfolio.LinkedInUrl" target="_blank" aria-label="LinkedIn" class="cv-icon-btn">
                                    <MudIcon Icon="@LucideIcons.Linkedin" Style="stroke: currentColor; fill: none; stroke-width: 2;" />
                                </a>
                            }
                        </div>
                    </div>

                    <div class="cv-avatar-wrapper">
                         @if (!string.IsNullOrEmpty(Portfolio.ProfileImageUrl))
                        {
                            <img class="cv-avatar-img" src="@Portfolio.ProfileImageUrl" alt="@Portfolio.FirstName @Portfolio.LastName" />
                        }
                        else
                        {
                            <div class="cv-avatar-placeholder">
                                @(Portfolio.FirstName?.FirstOrDefault())@(Portfolio.LastName?.FirstOrDefault())
                            </div>
                        }
                    </div>
                </header>

                <div class="cv-main-body">
                    @* About Section *@
                    @if (!string.IsNullOrEmpty(Portfolio.AboutMe))
                    {
                        <section class="cv-body-section">
                            <h2 class="cv-section-title">About</h2>
                            <div class="cv-about-text">
                                @Portfolio.AboutMe
                            </div>
                        </section>
                    }

                    @* Work Experience Section *@
                    @if (Portfolio.Experiences.Any())
                    {
                        <section class="cv-body-section">
                            <h2 class="cv-section-title">Work Experience</h2>
                            <div class="cv-experience-list" role="feed">
                                @foreach (var exp in Portfolio.Experiences.OrderByDescending(e => e.StartDate))
                                {
                                    <div class="cv-experience-item">
                                        <div class="cv-exp-header">
                                            <div class="cv-exp-title-group">
                                                <p class="cv-exp-position">@exp.Position</p>
                                                @if (!string.IsNullOrEmpty(exp.Location))
                                                {
                                                    <div class="cv-exp-location-badge">
                                                        <p class="cv-exp-location-text">@exp.Location</p>
                                                    </div>
                                                }
                                            </div>
                                            <p class="cv-exp-dates">
                                                @exp.StartDate.ToString("MMM yyyy") - @(exp.IsCurrent ? "Present" : exp.EndDate?.ToString("MMM yyyy"))
                                            </p>
                                        </div>
                                        <div class="cv-exp-sub">
                                            <p class="cv-exp-company-row">
                                                <span class="cv-exp-company">@exp.Company</span>
                                                @if (!string.IsNullOrEmpty(exp.EmploymentType))
                                                {
                                                    <span class="cv-dot">Â·</span>
                                                    <span class="cv-exp-type">@exp.EmploymentType</span>
                                                }
                                            </p>
                                            <p class="cv-exp-description">@exp.Description</p>
                                        </div>
                                    </div>
                                }
                            </div>
                        </section>
                    }

                    @* Education Section *@
                    @if (Portfolio.Education.Any())
                    {
                        <section class="cv-body-section">
                            <h2 class="cv-section-title">Education</h2>
                            <div class="cv-education-list">
                                @foreach (var edu in Portfolio.Education.OrderByDescending(e => e.StartDate))
                                {
                                    <article class="cv-edu-item">
                                        <div class="cv-edu-header">
                                            <h3 class="cv-edu-institution">@edu.Institution</h3>
                                            <div class="cv-edu-dates">@edu.StartDate.ToString("yyyy") - @(edu.EndDate?.ToString("yyyy") ?? "Present")</div>
                                        </div>
                                        <div class="cv-edu-degree">@edu.Degree</div>
                                    </article>
                                }
                            </div>
                        </section>
                    }

                    @* Skills Section *@
                    @if (Portfolio.Skills.Any())
                    {
                        <section class="cv-body-section">
                            <h2 class="cv-section-title">Skills</h2>
                            <ul class="cv-skills-list">
                                @foreach (var skill in Portfolio.Skills)
                                {
                                    <li><div class="cv-skill-tag">@skill.Name</div></li>
                                }
                            </ul>
                        </section>
                    }
                </div>
            </section>
        </div>
    </div>
}

<style>
    .cv-wrapper {
        padding: 2.5rem 1rem;
        background-color: transparent;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .cv-outer-container {
        max-width: 48rem; /* max-w-3xl */
        margin: 0 auto;
        width: 100%;
        background-color: #ffffff;
        border: 0.5px solid #d1d5db; /* border-neutral-300 approx */
        border-radius: 0.5rem; /* md:rounded-lg */
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
    }

    .cv-inner-content {
        max-width: 42rem; /* max-w-2xl */
        margin: 2rem auto; /* my-8 */
        padding: 0 1.5rem; /* px-4 */
        display: flex;
        flex-direction: column;
        gap: 2rem; /* space-y-8 */
    }

    @@media print {
        .cv-wrapper { padding: 0; }
        .cv-outer-container { border: none; box-shadow: none; max-width: 100%; }
        .cv-inner-content { margin: 1rem auto; gap: 1rem; }
    }

    /* Header */
    .cv-header {
        display: flex;
        justify-content: space-between;
        align-items: center; /* flex items-start md:items-center */
        gap: 1rem;
    }

    .cv-header-text {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
    }

    @@media (max-width: 640px) {
        .cv-header {
            flex-direction: column-reverse;
            text-align: center;
        }
        .cv-header-text {
            align-items: center;
        }
        .cv-social-links {
            justify-content: center;
        }
        .cv-headline {
            text-align: center;
        }
    }

    .cv-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: #050914;
    }

    .cv-headline {
        max-width: 28rem;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.875rem;
        color: #4b5563; /* text-design-resume */
        line-height: 1.25rem;
        text-wrap: pretty;
    }

    .cv-location {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.75rem;
        color: #050914;
    }

    .cv-location a {
        color: #9CA0A8;
        text-decoration: none;
    }

    .cv-location a:hover {
        text-decoration: underline;
    }

    .cv-social-links {
        display: flex;
        gap: 0.25rem;
        padding-top: 0.25rem;
    }

    .cv-icon-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        background-color: #ffffff;
        color: #050914;
        transition: background-color 0.2s;
    }

    .cv-icon-btn:hover {
        background-color: #f3f4f6;
    }

    .cv-icon-btn .mud-icon-root {
        width: 1rem !important;
        height: 1rem !important;
    }

    .cv-avatar-wrapper {
        flex-shrink: 0;
    }

    .cv-avatar-img, .cv-avatar-placeholder {
        width: 10rem;
        height: 10rem;
        border-radius: 10px;
        object-fit: cover;
    }

    @@media (min-width: 768px) {
        .cv-avatar-img, .cv-avatar-placeholder {
            width: 7rem;
            height: 7rem;
        }
    }

    .cv-avatar-placeholder {
        background-color: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 600;
        color: #9ca3af;
    }

    /* Main Body */
    .cv-main-body {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .cv-body-section {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .cv-section-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #050914;
    }

    .cv-about-text {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.875rem;
        color: #4b5563;
        line-height: 1.5rem;
        text-wrap: pretty;
    }

    /* Experience */
    .cv-experience-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .cv-experience-item {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .cv-exp-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .cv-exp-title-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .cv-exp-position {
        font-size: 1rem;
        font-weight: 600;
        color: #050914;
    }

    .cv-exp-location-badge {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0.125rem 0.4375rem;
        background-color: #eeeff0;
        border-radius: 0.25rem;
    }

    .cv-exp-location-text {
        font-size: 0.75rem;
        font-weight: 600;
        color: #54575e;
    }

    .cv-exp-dates {
        font-size: 0.875rem;
        color: #54575e;
        text-align: right;
    }

    .cv-exp-sub {
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
    }

    .cv-exp-company-row {
        font-size: 0.875rem;
        font-weight: 500;
        color: #54575e;
        text-transform: capitalize;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .cv-exp-description {
        font-size: 0.875rem;
        font-weight: 400;
        color: #6c737f;
        line-height: normal;
    }

    /* Education */
    .cv-education-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .cv-edu-item {
        display: flex;
        flex-direction: column;
    }

    .cv-edu-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
    }

    .cv-edu-institution {
        font-size: 1rem;
        font-weight: 600;
        color: #050914;
    }

    .cv-edu-dates {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.875rem;
        color: #6b7280;
    }

    .cv-edu-degree {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.875rem;
        color: #4b5563;
        margin-top: 0.5rem;
    }

    /* Skills */
    .cv-skills-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        list-style: none;
        padding: 0;
    }

    .cv-skill-tag {
        display: inline-flex;
        align-items: center;
        border-radius: 0.375rem;
        padding: 0.125rem 0.5rem;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.75rem;
        font-weight: 600;
        background-color: #111827;
        color: #ffffff;
    }
</style>

@code {
    [Parameter] public string username { get; set; } = string.Empty;
    [Inject] PortfolioStateService PortfolioState { get; set; } = null!;

    private PortfolioDto? Portfolio => PortfolioState.CurrentPortfolio;

    protected override void OnInitialized()
    {
        PortfolioState.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        PortfolioState.OnChange -= StateHasChanged;
    }
}
