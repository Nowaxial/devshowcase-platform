@page "/{username}/contact"
@layout PortfolioLayout
@using DevShowcase.Shared.DTOs.Public
@using DevShowcase.Client.Services
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>Contact @(Portfolio?.FirstName) @(Portfolio?.LastName)</PageTitle>

@if (Portfolio == null)
{
    @if (!PortfolioState.IsLoading)
    {
        <MudContainer MaxWidth="MaxWidth.Small" Class="mt-16 text-center">
            <MudText Typo="Typo.h4">Portfolio Not Found</MudText>
        </MudContainer>
    }
}
else
{
    <MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8 mb-16">
        <MudGrid>
            <!-- Form Section -->
            <MudItem xs="12" md="7">
                <MudText Typo="Typo.h3" Class="font-weight-bold mb-2">Get in Touch</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-8">Have a question or want to work together? Fill out the form below.</MudText>

                <EditForm Model="@_contactModel" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudTextField Label="Name" @bind-Value="_contactModel.Name" For="@(() => _contactModel.Name)" Variant="Variant.Outlined" Required="true" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField Label="Email" @bind-Value="_contactModel.Email" For="@(() => _contactModel.Email)" Variant="Variant.Outlined" Required="true" InputType="InputType.Email" />
                        </MudItem>

                        <MudItem xs="12">
                            <MudTextField Label="Subject" @bind-Value="_contactModel.Subject" For="@(() => _contactModel.Subject)" Variant="Variant.Outlined" Required="true" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField Label="Message" @bind-Value="_contactModel.Message" For="@(() => _contactModel.Message)" Variant="Variant.Outlined" Required="true" Lines="5" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" Disabled="_isSubmitting" Class="px-10">
                                @if (_isSubmitting)
                                {
                                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                    <MudText Class="ms-2">Sending...</MudText>
                                }
                                else
                                {
                                    <MudText>Send Message</MudText>
                                }
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </EditForm>
            </MudItem>

            <!-- Info Section -->
            <MudItem xs="12" md="5" Class="d-flex flex-column gap-6">
                <MudPaper Elevation="0" Class="pa-8 rounded-lg border-thin" Style="background-color: var(--mud-palette-background-grey);">
                    <MudText Typo="Typo.h5" Class="font-weight-bold mb-6">Contact Information</MudText>
                    
                    <div class="d-flex align-center mb-6">
                        <MudIcon Icon="@Icons.Material.Filled.Email" Color="Color.Primary" Class="mr-4" />
                        <div>
                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Email</MudText>
                            <MudText Typo="Typo.body1">@Portfolio.Email</MudText>
                        </div>
                    </div>

                    <div class="d-flex align-center mb-6">
                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Color="Color.Primary" Class="mr-4" />
                        <div>
                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Location</MudText>
                            <MudText Typo="Typo.body1">@Portfolio.Location</MudText>
                        </div>
                    </div>

                    <MudDivider Class="my-6" />

                    <MudText Typo="Typo.subtitle1" Class="font-weight-bold mb-4">Social Profiles</MudText>
                    <div class="d-flex gap-4">
                        @if (!string.IsNullOrEmpty(Portfolio.GithubUrl))
                        {
                            <MudIconButton Icon="@Icons.Custom.Brands.GitHub" Href="@Portfolio.GithubUrl" Target="_blank" Color="Color.Default" Variant="Variant.Outlined" />
                        }
                        @if (!string.IsNullOrEmpty(Portfolio.LinkedInUrl))
                        {
                            <MudIconButton Icon="@Icons.Custom.Brands.LinkedIn" Href="@Portfolio.LinkedInUrl" Target="_blank" Color="Color.Primary" Variant="Variant.Outlined" />
                        }
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudContainer>
}

@code {
    [Parameter] public string username { get; set; } = string.Empty;
    [Inject] PortfolioStateService PortfolioState { get; set; } = null!;
    [Inject] ApiService ApiService { get; set; } = null!;

    private PortfolioDto? Portfolio => PortfolioState.CurrentPortfolio;
    private ContactMessageDto _contactModel = new();
    private bool _isSubmitting = false;

    protected override void OnInitialized()
    {
        PortfolioState.OnChange += StateHasChanged;
    }

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        try
        {
            await ApiService.SendMessageAsync(username, _contactModel);
            Snackbar.Add("Message sent successfully!", Severity.Success);
            _contactModel = new(); // Reset form
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to send message: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    public void Dispose()
    {
        PortfolioState.OnChange -= StateHasChanged;
    }
}
