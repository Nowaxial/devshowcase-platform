@page "/{username}"
@using DevShowcase.Shared.DTOs.Public
@using DevShowcase.Client.Services
@implements IDisposable

<PageTitle>@(Portfolio?.FirstName + " " + Portfolio?.LastName ?? "Developer Portfolio")</PageTitle>

@if (Portfolio == null)
{
    @if (!PortfolioState.IsLoading)
    {
        <MudContainer MaxWidth="MaxWidth.Small" Class="mt-16 text-center">
            <MudText Typo="Typo.h4">Portfolio Not Found</MudText>
            <MudText Typo="Typo.body1" Class="mt-2">The requested user portfolio could not be found.</MudText>
        </MudContainer>
    }
}
else
{
    <MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8 mb-16">
        
        <!-- Header / Profile -->
        <div class="d-flex flex-column align-center text-center mb-12">
            @if (!string.IsNullOrEmpty(Portfolio.ProfileImageUrl))
            {
                <MudAvatar image="@Portfolio.ProfileImageUrl" Style="height:120px; width:120px;" Class="mb-4 elevation-4" />
            }
            else
            {
                <MudAvatar Color="Color.Primary" Style="height:120px; width:120px; font-size: 3rem;" Class="mb-4 elevation-4">
                    @(Portfolio.FirstName?.FirstOrDefault())@(Portfolio.LastName?.FirstOrDefault())
                </MudAvatar>
            }
            
            <MudText Typo="Typo.h3" Class="font-weight-bold mb-1">@Portfolio.FirstName @Portfolio.LastName</MudText>
            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mb-4">@Portfolio.Location</MudText>
            
            <MudText Typo="Typo.body1" Class="mud-text-secondary" Style="max-width: 600px;">
                @Portfolio.Bio
            </MudText>

            <div class="mt-6 d-flex gap-4">
                @if (!string.IsNullOrEmpty(Portfolio.Email))
                {
                    <MudIconButton Icon="@Icons.Material.Filled.Email" Href="@($"mailto:{Portfolio.Email}")" Color="Color.Default" />
                }
                @if (!string.IsNullOrEmpty(Portfolio.GithubUrl))
                {
                    <MudIconButton Icon="@Icons.Custom.Brands.GitHub" Href="@Portfolio.GithubUrl" Target="_blank" Color="Color.Default" />
                }
                @if (!string.IsNullOrEmpty(Portfolio.LinkedInUrl))
                {
                    <MudIconButton Icon="@Icons.Custom.Brands.LinkedIn" Href="@Portfolio.LinkedInUrl" Target="_blank" Color="Color.Primary" />
                }
            </div>
            
             <div class="mt-6">
                 <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="@($"/{username}/cv")">View CV</MudButton>
            </div>
        </div>

        <MudDivider Class="my-8" />

        <!-- Experience Section -->
        @if (Portfolio.Experiences.Any())
        {
            <MudText Typo="Typo.h5" Class="font-weight-bold mb-6">Experience</MudText>
            <div class="d-flex flex-column gap-6">
                @foreach (var exp in Portfolio.Experiences)
                {
                    <div class="d-flex gap-4">
                        <div class="d-flex flex-column align-center">
                             <MudIcon Icon="@Icons.Material.Filled.Work" Size="Size.Small" Color="Color.Primary" Class="mt-1" />
                             <div style="width: 2px; flex-grow: 1; background-color: var(--mud-palette-divider);" class="my-2"></div>
                        </div>
                        <div class="pb-6">
                            <MudText Typo="Typo.h6">@exp.Position</MudText>
                            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">@exp.Company â€¢ @exp.Location</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary mb-2 d-block">
                                @exp.StartDate.ToString("MMM yyyy") - @(exp.IsCurrent ? "Present" : exp.EndDate?.ToString("MMM yyyy"))
                            </MudText>
                            <MudText Typo="Typo.body2" Class="mt-2" Style="white-space: pre-line;">@exp.Description</MudText>
                        </div>
                    </div>
                }
            </div>
            
            <MudDivider Class="my-8" />
        }

        <!-- Projects Check (Just a teaser, mainly explicitly in /projects) -->
        @if (Portfolio.Projects.Any())
        {
             <div class="d-flex justify-space-between align-center mb-6">
                <MudText Typo="Typo.h5" Class="font-weight-bold">Recent Projects</MudText>
            </div>
            
            <MudGrid>
                @foreach (var project in Portfolio.Projects.Take(2))
                {
                     <MudItem xs="12" md="6">
                        <MudCard Elevation="2" Class="h-100">
                             @if (!string.IsNullOrEmpty(project.ImageUrl))
                            {
                                <MudCardMedia Image="@project.ImageUrl" Height="160" />
                            }
                            <MudCardContent>
                                <MudText Typo="Typo.h6">@project.Title</MudText>
                                <MudText Typo="Typo.body2" Class="mud-text-secondary mt-2 line-clamp-3">@project.Description</MudText>
                            </MudCardContent>
                            <MudCardActions>
                                @if (!string.IsNullOrEmpty(project.GithubUrl))
                                {
                                    <MudIconButton Icon="@Icons.Custom.Brands.GitHub" Href="@project.GithubUrl" Target="_blank" Size="Size.Small" />
                                }
                                @if (!string.IsNullOrEmpty(project.ProjectUrl))
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Link" Href="@project.ProjectUrl" Target="_blank" Size="Size.Small" Color="Color.Primary" />
                                }
                            </MudCardActions>
                        </MudCard>
                     </MudItem>
                }
            </MudGrid>
        }

    </MudContainer>
}

@code {
    [Parameter] public string username { get; set; } = "default";
    [Inject] PortfolioStateService PortfolioState { get; set; } = null!;
    
    private PortfolioDto? Portfolio => PortfolioState.CurrentPortfolio;

    protected override void OnInitialized()
    {
        PortfolioState.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        PortfolioState.OnChange -= StateHasChanged;
    }
}
