@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using DevShowcase.Client.Shared

<MudThemeProvider @ref="_mudThemeProvider" @bind-IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<style>
    /* Lucide icons are stroke-based. MudBlazor defaults to fill. 
       We need to override this for our custom SVG icons. */
    .lucide-icon {
        fill: none !important;
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
    }
</style>

<MudLayout>
    <MudAppBar Elevation="1" Color="Color.Surface" Dense="false">
        <MudText Typo="Typo.h5" Class="ml-3 font-weight-bold" Color="Color.Primary">DevShowcase</MudText>
        
        <MudSpacer />

        <!-- Desktop Navigation -->
        <MudHidden Breakpoint="Breakpoint.MdAndDown">
            <MudButton Href="" Variant="Variant.Text" StartIcon="@LucideIcons.Home" IconClass="lucide-icon" Class="mr-2">Home</MudButton>

            <AuthorizeView>
                <Authorized>
                    <MudButton Href="admin/dashboard" Variant="Variant.Text" StartIcon="@LucideIcons.Dashboard" IconClass="lucide-icon">Dashboard</MudButton>
                    <MudButton Href="admin/experience" Variant="Variant.Text" StartIcon="@LucideIcons.Briefcase" IconClass="lucide-icon">Experience</MudButton>
                    <MudButton Href="admin/projects" Variant="Variant.Text" StartIcon="@LucideIcons.Code" IconClass="lucide-icon">Projects</MudButton>
                    <MudButton Href="logout" Variant="Variant.Text" StartIcon="@LucideIcons.LogOut" IconClass="lucide-icon" Color="Color.Error">Logout</MudButton>
                </Authorized>
                <NotAuthorized>
                    <MudButton Href="login" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@LucideIcons.LogIn" IconClass="lucide-icon" Class="mr-2">Login</MudButton>
                    <MudButton Href="register" Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@LucideIcons.UserPlus" IconClass="lucide-icon">Register</MudButton>
                </NotAuthorized>
            </AuthorizeView>
        </MudHidden>

        <!-- Dark Mode Toggle -->
        <MudTooltip Text="@(_isDarkMode ? "Switch to Light Mode" : "Switch to Dark Mode")">
            <MudIconButton OnClick="@((e) => OnSystemDarkModeChanged(!_isDarkMode))"
                           Icon="@(_isDarkMode ? LucideIcons.Sun : LucideIcons.Moon)"
                           Class="lucide-icon ml-4" 
                           Color="Color.Inherit" />
        </MudTooltip>
        
        <!-- Mobile Menu (Hamburger) -->
        <MudHidden Breakpoint="Breakpoint.LgAndUp">
            <MudIconButton Icon="@LucideIcons.Dashboard" Class="lucide-icon ml-2" Color="Color.Inherit" OnClick="@((e) => DrawerToggle())" />
        </MudHidden>

    </MudAppBar>

    <!-- Mobile Drawer (Only visible on small screens) -->
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2" Anchor="Anchor.Right" Variant="DrawerVariant.Temporary">
        <NavMenu />
    </MudDrawer>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Large" Class="my-8 pt-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = false;

    private bool _isDarkMode = true;
    private MudThemeProvider _mudThemeProvider = null!;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _isDarkMode = await _mudThemeProvider.GetSystemDarkModeAsync();
            StateHasChanged();
        }
    }

    private Task OnSystemDarkModeChanged(bool newValue)
    {
        _isDarkMode = newValue;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
    }
}
